---
title: "Final Project Data Check"
author: Baker Dean and Caleb Ramsey
output: html_document
date: "2025-10-28"
---

```{r setup, include=FALSE}
# Setup
library(knitr)
infile <- knitr::current_input()
root <- if (is.null(infile)) getwd() else dirname(infile)
knitr::opts_knit$set(root.dir = root)
setwd(root)
stopifnot(file.exists("hdi_name_matcher.R"))
source("hdi_name_matcher.R", chdir = TRUE)
```

# MBB Code

```{r, message=FALSE, warning=FALSE}
# Imports
library(dplyr)
library(stringr)
library(cbbdata)

# Bring in HDI 2023 file (downloaded from Google sheet)
hdi23 <- read.csv("C:/Users/bwdea/OneDrive/Documents/STAT 3274/Final Project/Data/HDI Ratings 2023-24.csv")
hdi23 <- hdi23 %>% rename(Name = Full.Name, Team = X2023.2024.School) %>% select(Name, Team, Rating)

# Scrape barttorvik 2023 data using cbbdata API
barttorvik_2023 <- cbd_torvik_player_season(year = 2024)
barttorvik_2023 <- barttorvik_2023 %>% rename(Name = player, Team = team)

# Join HDI ratings to the 2023 barttorvik data
ratings_23 <- join_hdi_rating(barttorvik_2023, hdi23) %>% select(Name, pos, exp, hgt, Team, conf, mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, ft_pct, tov, ast_to, efg, ts, usg, ortg, drtg, rim_pct, mid_pct, obpm, dbpm, bpm, ftr, pfr, HDI_Rating, year) %>% rename(Rating = HDI_Rating) %>% filter(!is.na(Rating)) #24 umatched
basic_ratings_23 <- ratings_23 %>% select(Name, pos, exp, hgt, Team, conf, mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, ft_pct, tov, ast_to, efg, ts, Rating, year)

# Bring in HDI 2024 file (downloaded from Google sheet)
hdi24 <- read.csv("C:/Users/bwdea/OneDrive/Documents/STAT 3274/Final Project/Data/HDI Ratings 2024-25.csv")
hdi24 <- hdi24 %>% rename(Name = Full.Name, Team = X2024.2025.School) %>% select(Name, Team, Rating)

# Scrape barttorvik 2024 data using cbbdata API
barttorvik_2024 <- cbd_torvik_player_season(year = 2025)
barttorvik_2024 <- barttorvik_2024 %>% rename(Name = player, Team = team)

# Join HDI ratings to the 2024 barttorvik data
ratings_24 <- join_hdi_rating(barttorvik_2024, hdi24) %>% select(Name, pos, exp, hgt, Team, conf, mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, ft_pct, tov, ast_to, efg, ts, usg, ortg, drtg, rim_pct, mid_pct, obpm, dbpm, bpm, ftr, pfr, HDI_Rating, year) %>% rename(Rating = HDI_Rating) %>% filter(!is.na(Rating)) #153 Umatched
basic_ratings_24 <- ratings_24 %>% select(Name, pos, exp, hgt, Team, conf, mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, ft_pct, tov, ast_to, efg, ts, Rating, year)
```

# Datasets

HDI 2023:

```{r}
head(hdi23)
```

barttorvik 2023:

```{r}
head(barttorvik_2023)
```

Full dataset for 2023 season:

```{r}
head(ratings_23)
```

HDI 2024:

```{r}
head(hdi24)
```

barttorvik 2024:

```{r}
head(barttorvik_2024)
```

Full dataset for 2024 season:

```{r}
head(ratings_24[order(-ratings_24$Rating), ], 10)
```

# Collection Process - Men's

For the mens side of the project, collecting the data was a combination of webscraping and dataset manipulation. HDI is a company that provides a rating system for college basketball players using a variety of advanced statistics. After accessing their data via a Google Sheet that the Virginia Tech Men's Basketball team provided, the HDI ratings and stats were downloaded to a csv that could be imported into this R project. Since part of the goal includes simplify the equation that makes player ratings, the cbbdata package developed by Andrew Weatherman was used to scrape data from barttorvik.com for the corresponding seasons. After obtaining both of these datasets the two were joined using a customized function to assing HDI ratings to almost all of the players in the barttorvik dataset. Rows that contained NA values and players that only appeared in one of the datasets were removed and special care was taken to handle difficult cases like multiple players with the same name.  

# References

Kartes, Weston. MBB Player Database 2024. HD Intelligence. https://www.hdintelligence.com/mbb-player-database-2024 

Kartes, Weston. MBB Player Database 2025. HD Intelligence. https://www.hdintelligence.com/mbb-player-database-2025 

Torvik, Bart. NCAAM Player Stats 2024. barttorvik. https://barttorvik.com/playerstat.php?year=2024 

Torvik, Bart. NCAAM Player Stats 2025. barttorvik. https://barttorvik.com/playerstat.php?year=2025 



# WBB Code

```{r}
# libraries
library(dplyr); library(tidyr); library(purrr); library(stringr)
library(readr); library(tibble); library(fs); library(wehoop)
library(lubridate); library(here); library(rlang)

# D1 labels
D1_CONF = c(
  "ACC","AAC","AEC","ASUN","A10","B12",
  "Big East","Big Sky","Big South","Big Ten","Big West",
  "CAA","CUSA","Horizon","Ivy League","MAAC","MAC","MEAC",
  "MVC","Mountain West","NEC","OVC","Pac 12","Patriot","SEC","SoCon",
  "Southland","Summit League","Sun Belt","SWAC","WAC","WCC")

# Sample-size thresholds
MIN_MINUTES = 200
MIN_GAMES = 10

season = 2025
players_path = here("main/wcbb_players_2025_D1.csv")
out_dir = here("main/processed"); dir_create(out_dir)

# Helper functions
mode_non_na = function(x)
  {
  x = x[!is.na(x) & x != ""]; if (!length(x))(return(NA_character_)) 
  names(sort(table(x), T))[1]
  }

find_col = function(df, include_patterns, exclude_patterns = NULL)
  {
  nms = tolower(names(df))
  hit = Reduce(`|`, lapply(include_patterns, \(p) grepl(p, nms)))
  if (!is.null(exclude_patterns) && length(exclude_patterns)) hit = hit & !Reduce(`|`, lapply(exclude_patterns, \(p) grepl(p, nms)))
  idx = which(hit); if (length(idx)) names(df)[idx[1]]else NULL
  }
col_or_na = function(df, col_name) if(is.null(col_name)){rep(NA_character_, nrow(df))} else{df[[col_name]]}
pick_num = function(df, candidates, default = 0)
  {
  nm = intersect(candidates, names(df))
  if(length(nm)) suppressWarnings(as.numeric(df[[nm[1]]]))else{rep(default, nrow(df))}
  }

pick_chr = function(df, candidates, default = NA_character_)
  {
  nm = intersect(candidates, names(df))
  if(length(nm)) as.character(df[[nm[1]]])else{rep(default, nrow(df))}
  }

to_min = function(x)
  {
  if (is.numeric(x))return(as.numeric(x)); ifelse(is.na(x) | x == "", NA_real_, as.numeric(sub(":.*","",x)) + as.numeric(sub(".*:","",x))/60) 
  }

# Build 2025 season totals
players_g = wehoop::load_wbb_player_box(seasons = season); stopifnot(nrow(players_g) > 0)

players_wehoop =
  players_g %>%
  transmute(
    athlete_id = pick_chr(., c("athlete_id","player_id","athleteId","playerId")),
    player_name = pick_chr(., c("display_name","athlete_display_name","player","player_name","name")),
    team_id = pick_chr(., c("team_id","teamId")),
    team_name = pick_chr(., c("team_display_name","team_short_display_name","team_name")),
    minutes = to_min(pick_chr(., c("minutes","mins","time_played"))),
    points = pick_num(., c("points","pts")),
    rebounds = pick_num(., c("rebounds","reb_total")),
    defensive_rebounds = pick_num(., c("defensive_rebounds","defensiveRebounds","dreb")),
    offensive_rebounds = pick_num(., c("offensive_rebounds","offensiveRebounds","oreb")),
    assists = pick_num(., c("assists","ast")),
    steals = pick_num(., c("steals","stl")),
    blocks = pick_num(., c("blocks","blk")),
    turnovers = pick_num(., c("turnovers","tov")),
    personal_fouls = pick_num(., c("personal_fouls","pf")),
    field_goals_made = pick_num(., c("field_goals_made","fgm")),
    field_goals_attempted = pick_num(., c("field_goals_attempted","fga")),
    three_point_made = pick_num(., c("three_point_field_goals_made","three_points_made","three_pm","tpm")),
    three_point_attempted = pick_num(., c("three_point_field_goals_attempted","three_points_attempted","three_pa","tpa")),
    free_throws_made = pick_num(., c("free_throws_made","ftm")),
    free_throws_attempted = pick_num(., c("free_throws_attempted","fta"))
    ) %>% group_by(athlete_id, player_name, team_id, team_name) %>%
  summarise(
    across(c(minutes, points, rebounds, defensive_rebounds, offensive_rebounds,
             assists, steals, blocks, turnovers, personal_fouls,
             field_goals_made, field_goals_attempted,
             three_point_made, three_point_attempted,
             free_throws_made, free_throws_attempted), \(x) sum(x, na.rm = T)),
    games_played = dplyr::n(), .groups = "drop"
    ) %>%
  mutate(
    field_goal_percent = if_else(field_goals_attempted > 0, field_goals_made / field_goals_attempted, NA_real_),
    three_point_percent = if_else(three_point_attempted > 0, three_point_made / three_point_attempted, NA_real_),
    free_throw_percent = if_else(free_throws_attempted  > 0, free_throws_made / free_throws_attempted, NA_real_)
    ) %>% filter(minutes > 0)

# Write CSV of scraped players for mapping
write_csv(players_wehoop, players_path)

# Map teams to conferences
players = readr::read_csv(players_path, show_col_types = F)
athlete_col = intersect(c("athleteID","athlete_id","player_id"), names(players))[1]
team_col = intersect(c("team_ID","team_id","teamId"), names(players))[1]
player_name_col = intersect(c("player","player_name","name","display_name"), names(players))[1]
if(is.na(player_name_col)){player_name_col = NULL}

# Establish dataset for mapping
players_joined =
  players %>%
  mutate(!!rlang::sym(athlete_col) := as.character(.data[[athlete_col]]),
         !!rlang::sym(team_col)  := as.character(.data[[team_col]])) %>%
  {if(!"position" %in% names(.)) mutate(., position = NA_character_) else .}

# Use wehoop to pull 2025 regular WBB season schedule
sched = wehoop::load_wbb_schedule(seasons = season, season_types = "Regular Season")
pick_exact = function(df, candidates)
  {
  ln = tolower(names(df)); for(c in tolower(candidates)){
    i = match(c, ln, nomatch = 0); if(i > 0) return(names(df)[i])
    }; NULL
  }

# Pulling game ids, home team, away team
gid_col = pick_exact(sched, c("game_id","id"))
h_col = pick_exact(sched, c("home_team_id","home_id"))
a_col = pick_exact(sched, c("away_team_id","away_id"))

h_team_col = find_col(sched, c("^home.*team.*id$","^home.*id$","^home_team_id$"))
a_team_col = find_col(sched, c("^away.*team.*id$","^away.*id$","^away_team_id$"))
h_conf_id = find_col(sched, c("^home.*conference.*id$","^home.*group.*id$"))
h_conf_name = find_col(sched, c("^home.*conference.*name$","^home.*group.*display.*name$","^home.*group.*name$"))
a_conf_id = find_col(sched, c("^away.*conference.*id$","^away.*group.*id$"))
a_conf_name = find_col(sched, c("^away.*conference.*name$","^away.*group.*display.*name$","^away.*group.*name$"))
h_team_name = find_col(sched, c("^home.*team.*display.*name$","^home.*team.*name$","^home.*short.*name$"))
a_team_name = find_col(sched, c("^away.*team.*display.*name$","^away.*team.*name$","^away.*short.*name$"))

home_obs = tibble::tibble(
  team_id = as.character(col_or_na(sched, h_team_col)),
  team_name_meta = as.character(col_or_na(sched, h_team_name)),
  conference_id = as.character(col_or_na(sched, h_conf_id)),
  conference_name = as.character(col_or_na(sched, h_conf_name))
  )

away_obs = tibble::tibble(
  team_id = as.character(col_or_na(sched, a_team_col)),
  team_name_meta = as.character(col_or_na(sched, a_team_name)),
  conference_id = as.character(col_or_na(sched, a_conf_id)),
  conference_name = as.character(col_or_na(sched, a_conf_name))
  )

teams_meta =
  dplyr::bind_rows(home_obs, away_obs) %>%
  dplyr::mutate(dplyr::across(dplyr::everything(), ~na_if(.x, ""))) %>%
  dplyr::filter(!is.na(team_id)) %>%
  dplyr::group_by(team_id) %>%
  dplyr::summarise(
    team_name_meta = mode_non_na(team_name_meta),
    conference_id  = mode_non_na(conference_id),
    conference_name = mode_non_na(conference_name),
    .groups = "drop"
    )

# Mapping team id to team name
team_id_to_name = teams_meta %>% dplyr::select(team_id, team_name = team_name_meta) %>% dplyr::distinct()

team_conf_auto =
  players %>% dplyr::transmute(team_id = as.character(.data[[team_col]])) %>% dplyr::distinct() %>%
  dplyr::left_join(teams_meta, by = "team_id") %>%
  dplyr::left_join(team_id_to_name, by = "team_id") %>%
  dplyr::mutate(team_name = dplyr::coalesce(team_name, team_name_meta)) %>%
  dplyr::select(team_id, team_name, conference_name, conference_id)

# Using text file of all 361 D1 teams to map conferences
map_file = "main/conf_name_map.txt"
if (file.exists(map_file)) {
  map_lines = readLines(map_file)
  map_df = tibble::tibble(raw = map_lines) %>%
    dplyr::mutate(
      team_id = stringr::str_match(raw, '^"([0-9]+)"')[,2],
      conf    = stringr::str_match(raw, '"\\s*=\\s*"(.*?)"')[,2]
      ) %>%
    dplyr::filter(!is.na(team_id), !is.na(conf), conf != "")
  team_conf_override = tibble::tibble(team_id = map_df$team_id, conference_name = map_df$conf, conference_id = map_df$conf)
  team_conf_auto = team_conf_auto %>%
    dplyr::left_join(team_conf_override, by = "team_id", suffix = c("_auto","_hard")) %>%
    dplyr::mutate(conference_name = dplyr::coalesce(conference_name_hard, conference_name_auto),
                  conference_id   = dplyr::coalesce(conference_id_hard,   conference_id_auto)) %>%
    dplyr::select(team_id, team_name, conference_name, conference_id)
  }

team_conf_map_final = team_conf_auto %>% dplyr::rename(team_name_map = team_name) %>%
  dplyr::select(team_id, team_name_map, conference_name, conference_id)

# Enriched dataset with player and conference data
players_enriched_2025 =
  players_joined %>%
  dplyr::left_join(team_conf_map_final, by = setNames("team_id", team_col)) %>%
  dplyr::mutate(team_name = dplyr::coalesce(.data[["team_name"]], .data[["team_name_map"]])) %>%
  dplyr::transmute(
    athlete_id = as.character(.data[[athlete_col]]),
    player_name = if (!is.null(player_name_col)) .data[[player_name_col]] else NA_character_,
    position,
    team_id = .data[[team_col]],
    team_name,
    conference_name,
    blocks = dplyr::coalesce(.data[["blocks"]], 0),
    defensive_rebounds = dplyr::coalesce(.data[["defensive_rebounds"]], 0),
    steals = dplyr::coalesce(.data[["steals"]], 0),
    rebounds = dplyr::coalesce(.data[["rebounds"]], 0),
    minutes = dplyr::coalesce(.data[["minutes"]], 0),
    games_played = dplyr::coalesce(.data[["games_played"]], 0),
    assists = dplyr::coalesce(.data[["assists"]], 0),
    field_goals_attempted = dplyr::coalesce(.data[["field_goals_attempted"]], 0),
    field_goals_made      = dplyr::coalesce(.data[["field_goals_made"]], 0),
    field_goal_percent    = dplyr::coalesce(.data[["field_goal_percent"]], NA_real_),
    three_point_made      = dplyr::coalesce(.data[["three_point_made"]], 0),
    three_point_attempted = dplyr::coalesce(.data[["three_point_attempted"]], 0),
    three_point_percent   = dplyr::coalesce(.data[["three_point_percent"]],
                                            dplyr::if_else(dplyr::coalesce(.data[["three_point_attempted"]],0) > 0,
                                                           .data[["three_point_made"]]/.data[["three_point_attempted"]],
                                                           NA_real_)),
    free_throw_percent    = dplyr::coalesce(.data[["free_throw_percent"]], NA_real_),
    free_throws_attempted = dplyr::coalesce(.data[["free_throws_attempted"]], 0),
    free_throws_made      = dplyr::coalesce(.data[["free_throws_made"]], 0),
    offensive_rebounds = dplyr::coalesce(.data[["offensive_rebounds"]], 0),
    points = dplyr::coalesce(.data[["points"]], 0),
    turnovers        = dplyr::coalesce(.data[["turnovers"]], 0),
    personal_fouls   = dplyr::coalesce(.data[["personal_fouls"]], 0)
    ) %>%
  dplyr::arrange(dplyr::desc(minutes), dplyr::desc(games_played)) %>%
  dplyr::filter(conference_name %in% D1_CONF)

# Write final csv
readr::write_csv(players_enriched_2025, file.path(out_dir, "wcbb_players_2025_with_team_conf_pos.csv"))
```

# Dataset

WCBB 2025:

```{r}
head(players_enriched_2025)
```

# Collection Process - Women's
Data came from ESPN via the "wehoop" package. I pulled 2025 WBB game-by-game box scores with load_wbb_player_box, then aggregated to season totals per athlete. I pulled the 2025 schedule with load_wbb_schedule and mapped each team to a conference using available team/conference fields. I also allowed manual overrides via a text file for cases where a conference couldn't be established. I filtered to D1 conferences only and enforced basic minimums (mins = 200, min_games = 10). Output is a cleaned player table with player totals and conference labels. Some assumptions to note are: ESPN IDs are stable within season. Minutes may appear as "MM:SS", so I normalized to decimal minutes. If a percentage denominator is zero, the percentage is set to NA.

# References 
ESPN Women's college basketball data (via wehoop)
ESPN 2025 schedules and boxscores (via wehoop) 
Hird, K. wehoop: Women's Basketball Data for R: https://github.com/sportsdataverse/wehoop
