---
title: "Stat 3274 Final Project Progress Report"
author: Baker Dean & Caleb Ramsey
output: pdf_document
---

```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(randomForest)
mbb_raw <- read.csv("Data/bt2024.csv")
wbb_raw <- read.csv("Data/wcbb_players_2025_D1.csv")
men_4099 <- read.csv("Data/men_4099.csv")
women_4099 <- read.csv("Data/women_4099.csv")
ratings_23 <- read.csv("Data/ratings_23.csv")
ratings_24 <- read.csv("Data/ratings_24.csv")
hdi23 <- read.csv("Data/HDI Ratings 2023-24.csv")
hdi24 <- read.csv("Data/HDI Ratings 2024-25.csv")
```

# Research Question

How can we create a player rating system for men’s and women’s college basketball that accounts for both player performance and conference strength, allowing staff to compare athletes across divisions and evaluate transfer portal talent more effectively?

# Abstract

In this new age of college basketball evaluating the talent of players across the nation is more important than ever given the new transfer portal and NIL rules. Player movement is at an all-time high with teams often turning over more than 75% of their teams every offseason and with players able to be paid for their services coaches and general managers must be aware of the true value of a player, how much to offer him/her and how to allocate all their financial resources. With many players choosing to move between the Power 5 conferences (ACC, Big Ten, Big 12, Big East, and SEC) and the many smaller conferences, evaluating the skill and fit of a player is not as simple as simply pulling ups stats and sorting by points per game. With such a wide variety of levels of talent, determining how to account for the level of competition they faced becomes an important factor alongside the performance of the player.

This project seeks to accurately handle this issue by creating a video-game style player ratings system that will assign every player in the nation a single number that represents the level of competition they faced and their individual performance. We will determine level of competition by analyzing the conference the player played and rate their stats using a model based on previously existing but potentially flawed rankings. We will apply our ratings to the 2024-25 season to evaluate its accuracy since we have full data for that season but the end-goal is a tool that can be used to rank and project player performance when scouting transfer portal players. 

# Methods

## Data Collection

### Men's

For the men's side of the project, collecting the data was a combination of webscraping and dataset manipulation. HDI is a company that provides a rating system for college basketball players using a variety of advanced statistics. After accessing their data via a Google Sheet that the Virginia Tech Men's Basketball team provided, the HDI ratings and stats were downloaded to a csv that could be imported into this R project. Since part of the goal includes simplify the equation that makes player ratings, the `cbbdata` package developed by Andrew Weatherman was used to scrape data from barttorvik.com for the corresponding seasons. After obtaining both of these datasets the two were joined using a customized function to assing HDI ratings to almost all of the players in the barttorvik dataset. Rows that contained NA values and players that only appeared in one of the datasets were removed and special care was taken to handle difficult cases like multiple players with the same name.

```{r, include=FALSE}
model_data_printing <- read.csv("Data/ratings_24.csv") %>% select(
  mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, ft_pct, tov, ast_to, efg, ts, Rating) %>% mutate(
    mpg = round(mpg),
    ppg = round(ppg,1),
    rpg = round(rpg,1),
    apg = round(apg,1),
    spg = round(spg,1),
    bpg = round(bpg,1),
    two_pct = round(two_pct*100,1),
    three_pct = round(three_pct*100,1),
    ft_pct = round(ft_pct*100,1),
    tov = round(tov,1),
    ast_to = round(ast_to,2),
    ts = round(ts,1)) %>% rename(
      `2%` = two_pct,
      `3%` = three_pct,
      `ft%` = ft_pct,
      Rtg = Rating,
      a_to = ast_to)
```
```{r, include=FALSE}
head(model_data_printing,5)
```
```{r, include=FALSE}
mbb_raw_printing <- mbb_raw %>% select(
  Name, mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, ft_pct, tov, ast_to, efg, ts) %>% mutate(
    mpg = round(mpg),
    ppg = round(ppg,1),
    rpg = round(rpg,1),
    apg = round(apg,1),
    spg = round(spg,1),
    bpg = round(bpg,1),
    two_pct = round(two_pct*100,1),
    three_pct = round(three_pct*100,1),
    ft_pct = round(ft_pct*100,1),
    tov = round(tov,1),
    ast_to = round(ast_to,2),
    ts = round(ts,1)) %>% rename(
      `2%` = two_pct,
      `3%` = three_pct,
      `ft%` = ft_pct,
      a_to = ast_to) %>%
  arrange(Name)
```
```{r}
head(mbb_raw_printing,5)
```

This is the data we will use to assign the men's ratings.

### Women's

Data came from ESPN via the `wehoop` package. I pulled 2025 WBB game-by-game box scores with `load_wbb_player_box`, then aggregated to season totals per athlete. I pulled the 2025 schedule with `load_wbb_schedule` and mapped each team to a conference using available team/conference fields. I also allowed manual overrides via a text file for cases where a conference couldn't be established. I filtered to D1 conferences only and enforced basic minimums (mins = 200, min_games = 10). Output is a cleaned player table with player totals and conference labels. Some assumptions to note are: ESPN IDs are stable within season. Minutes may appear as "MM:SS", so I normalized to decimal minutes. If a percentage denominator is zero, the percentage is set to NA.

```{r, include=FALSE}
wbb_raw_printing <- wbb_raw %>% mutate(
  mpg = minutes / games_played,
  ppg = points / games_played,
  rpg = rebounds / games_played,
  apg = assists / games_played,
  spg = steals / games_played,
  bpg = blocks / games_played,
  tov = turnovers / games_played,
  two_fg_made = field_goals_made - three_point_made,
  two_fg_att  = field_goals_attempted - three_point_attempted,
  two_pct = ifelse(two_fg_att > 0, two_fg_made / two_fg_att, NA_real_),
  ast_to = ifelse(turnovers > 0, assists / turnovers, NA_real_),
  efg = ifelse(field_goals_attempted > 0, (field_goals_made + 0.5 * three_point_made) / field_goals_attempted, NA_real_),
  ts = ifelse(field_goals_attempted + 0.44 * free_throws_attempted > 0, points / (2 * (field_goals_attempted + 0.44 * free_throws_attempted)), NA_real_)) %>% select(
    player_name, team_name, mpg, ppg, rpg, apg, spg, bpg, two_pct, three_point_percent, free_throw_percent, tov, ast_to, efg, ts) %>% mutate(
      mpg = round(mpg),
      ppg = round(ppg,1),
      rpg = round(rpg,1),
      apg = round(apg,1),
      spg = round(spg,1),
      bpg = round(bpg,1),
      two_pct = round(two_pct*100,1),
      three_point_percent = round(three_point_percent*100,1),
      free_throw_percent = round(free_throw_percent*100,1),
      tov = round(tov,1),
      ast_to = round(ast_to,2),
      ts = round(ts*100,1),
      efg = round(efg*100,1)) %>% rename(
      `2%` = two_pct,
      `3%` = three_point_percent,
      `ft%` = free_throw_percent,
      a_to = ast_to) %>%
  na.omit() %>%
  select(-team_name) %>%
  arrange(player_name)
```
```{r}
head(wbb_raw_printing,5)
```

This is the data we will use to assign the women's ratings.

## Data Manipulation

After gathering the HDI stats for the men, we trained a random forest model on the data to predict a players rating based on ppg (points per game), rpg (rebounds per game), apg (assists per game), spg (steals per game), bpg (blocks per game), two_pct (2 point shot percentage), three_pct (3 point shot percentage), ft_pct (free throw percentage), tov (turnovers per game), ast_to (assist to turnover ratio), efg (effective field goal percentage), ts (true shooting percentage), and ftr (free throw rate). We then applied this model to the men's and women's data to assign each player a "statistics score".

Men's:

```{r}
head(men_4099,5)
```

Women's:

```{r}
head(women_4099,5)
```

Looking at the outputs it is obvious that we are not finished with the project since players from Ball State and Duquesne are not the top players in the nation but instead putting up excellent stats on bad teams against poor competition. This justifies the need for some form of conference weighting which we will accomplish using strength of schedule and conference performance numbers.

# Analysis

To evaluate how well our statistical model replicates the original HDI ratings, we compared our model's predictions against the actual HDI ratings for the men's basketball players:

```{r, message=FALSE, warning=FALSE, include=FALSE}
hdi23_simple <- hdi23 %>%
  rename(Name = Full.Name, Team = X2023.2024.School) %>%
  select(Name, Team, Rating)

hdi24_simple <- hdi24 %>%
  rename(Name = Full.Name, Team = X2024.2025.School) %>%
  select(Name, Team, Rating)

ratings <- rbind(ratings_23, ratings_24)
ratings_model_data <- ratings %>% 
  select(mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, ft_pct, 
         tov, ast_to, efg, ts, ftr, Rating) %>% 
  na.omit()

set.seed(3274)
index <- sample(nrow(ratings_model_data), size = floor(0.8*nrow(ratings_model_data)))
train <- ratings_model_data[index, ]
test  <- ratings_model_data[-index, ]
ratings_model <- randomForest(
  Rating ~ mpg + ppg + rpg + apg + spg + bpg + two_pct + three_pct + 
           ft_pct + tov + ast_to + efg + ts + ftr,
  data = train, ntree = 1000, importance = TRUE
)

ratings_24_comparison <- ratings_24 %>%
  select(Name, Team, mpg, ppg, rpg, apg, spg, bpg, two_pct, three_pct, 
         ft_pct, tov, ast_to, efg, ts, ftr, Rating) %>%
  na.omit()

ratings_24_comparison$predicted_rating <- predict(ratings_model, newdata = ratings_24_comparison)

ratings_24_comparison <- ratings_24_comparison %>%
  mutate(
    Our_Rating = 40 + (predicted_rating - min(predicted_rating)) * 
                  (59 / (max(predicted_rating) - min(predicted_rating)))
  ) %>%
  rename(HDI_Rating = Rating)

cor_value <- cor(ratings_24_comparison$HDI_Rating, 
                 ratings_24_comparison$Our_Rating, 
                 use = "complete.obs")
rmse_value <- sqrt(mean((ratings_24_comparison$HDI_Rating - 
                        ratings_24_comparison$Our_Rating)^2, na.rm = TRUE))
mean_diff <- mean(ratings_24_comparison$Our_Rating - 
                  ratings_24_comparison$HDI_Rating, na.rm = TRUE)

plot <- ggplot(ratings_24_comparison, aes(x = HDI_Rating, y = Our_Rating)) +
  geom_point(alpha = 0.4, size = 2, color = "steelblue") +
  annotate("text", x = 50, y = 95, 
           label = paste0("r^2: ", round(cor_value^2, 3)), 
           hjust = 0, size = 4, fontface = "bold") +
  labs(
    title = "HDI vs. Stats Rating 2024-25",
    x = "HDI Rating",
    y = "Our Statistical Rating",
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    axis.title = element_text(size = 11),
    plot.caption = element_text(size = 9, hjust = 0)
  ) +
  coord_fixed(ratio = 1, xlim = c(40, 100), ylim = c(40, 100))
```
```{r}
print(plot)
```

Since our ratings were scaled to be 40-99 (similar to NBA2K, a basketball video game) and have not been adjusted for conference weight yet, this shape is perfectly reasonable and an indication that the statistical portion of the code is working. There are only a few outliers and the narrowing of the graph at the top is to be expected given a fewer number of elite players. A 91% r^2 value indicates that the stats we used in the model account for 91% of the variability in the ratings which is a great report given that we could not scrape many of the more advanced statistics for the women's players.

## Potential Limitations (so far)

One of the problems we ran into was applying a model trained on men's data to the women's game, the original outputs were too low (top players were in the 70s) due to the different paces and styles so this led us to scaling the ratings. 

As we have begun to work on adjusting for conferences it is difficult to bring down top mid-major players without destroying the middle tier players from lower conferences so we are still working on a way to balance this out.

# References


Weatherman A (2024). `cbbdata`: API for College Basketball Data. R package version 0.3.0.9000, https://cbbdata.aweatherman.com/

Kartes, Weston. MBB Player Database 2024. HD Intelligence. https://www.hdintelligence.com/mbb-player-database-2024 

Kartes, Weston. MBB Player Database 2025. HD Intelligence. https://www.hdintelligence.com/mbb-player-database-2025 

Torvik, Bart. NCAAM Player Stats 2024. barttorvik. https://barttorvik.com/playerstat.php?year=2024 

Torvik, Bart. NCAAM Player Stats 2025. barttorvik. https://barttorvik.com/playerstat.php?year=2025 

ESPN Women's college basketball data (via `wehoop`)

ESPN 2025 schedules and boxscores (via `wehoop`) 

Hird, K. `wehoop`: Women's Basketball Data for R: https://github.com/sportsdataverse/wehoop